syntax = "proto3";

package mountmanager;

service MountManager {
  // 创建/挂载一个 mergerfs 合并挂载点
  rpc CreateMount(CreateMountRequest) returns (CreateMountResponse);

  // 卸载/删除一个挂载点
  rpc RemoveMount(RemoveMountRequest) returns (RemoveMountResponse);

  // 列出由服务管理的挂载点（DB 中记录 + 当前 mount 输出校验）
  rpc ListMounts(ListMountsRequest) returns (ListMountsResponse);

  // 查询单个挂载点状态
  rpc GetMount(GetMountRequest) returns (GetMountResponse);
}

message CreateMountRequest {
  string dest_path = 1;          // 目标挂载路径（绝对路径）
  repeated string branches = 2; // 源目录数组（绝对路径）
  bool allow_force_unmount = 3; // 如果目标已经挂载，是否先 fusermount -uz 再挂
  string options = 4;           // (可选) mergerfs 额外 mount options
}

message CreateMountResponse {
  bool ok = 1;
  string message = 2;
}

message RemoveMountRequest {
  string dest_path = 1;          // 目标挂载路径（绝对路径）
  bool recursive = 2;           // 是否递归删除子挂载
  bool force = 3;               // 如果 true 尝试 fusermount -uz 再 umount
}

message RemoveMountResponse {
  bool ok = 1;
  string message = 2;
}

message ListMountsRequest {
  string dest_path = 1;    // 目标挂载根目录目录（绝对路径），如果不指定则列出所有的挂载
  bool recursive = 2;     // 是否递归列出子挂载
}

message MountEntry {
  string dest_path = 1;            // 目标挂载路径
  repeated string branches = 2;    // 挂载的源目录数组（绝对路径）
  bool mounted = 3;                // 是否在当前 mount 列表里被确认为挂载
  string mount_opts = 4;           // mergerfs mount options
  string created_at = 5;           // 创建时间
}

message ListMountsResponse {
  repeated MountEntry entries = 1;
}

message GetMountRequest {
  string dest_path = 1;            // 目标挂载路径
}

message GetMountResponse {
  MountEntry entry = 1;
  bool found = 2;
}